<script src="https://checkout.stripe.com/checkout.js"></script>

<script>
  (function ($) {
    $(window).ready(function () {
      var giftCertificate;

      var handler = StripeCheckout.configure({
        key: "<%= @stripe_publishable_key %>",
        image: '/assets/noimage/small.png',
        token: function(token) {
          var payload = {
            id: giftCertificate.id,
            stripeToken: token
          };
          $.post("/buy_gift_certificate", payload, function (data, status, xhr) {
            // If error is returned and it is a stripe error, pop the stripe box back up
            console.log('success!');
            console.log(data);
          }).fail(function (data, status, xhr) {
            console.log("FAIL");
            console.log(data);
          });
        }
      });

      // Form is submitted via AJAX. If successful, just bring up the payment form.
      // If unsuccessful, the server will redirect
      var form = $('form#new_gift_certificate');
      form.on('ajax:success', function (event, data, status, xhr) {
        giftCertificate = data;
        var amount = giftCertificate.amount;

        handler.open({
          name: "<%= Spree::Config.site_name %>",
          email: $('#gift_certificate_sender_email').val(),
          description: 'Gift Certificate purchase',
          amount: Number(amount) * 100 // cents
        });
      }).on('ajax:error', function (event, data, status, xhr) {
        var errorString = data.responseJSON.join('<br/>');
        show_flash('error', errorString);
      });
    });
  })(jQuery);
</script>